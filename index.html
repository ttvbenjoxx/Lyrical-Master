<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lyrical Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Global Styles */
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    
    h1 {
      font-weight: bold;
      color: #333;
      margin-top: 2rem;
    }
    
    .note {
      font-size: 0.9rem;
      color: #777;
      margin-top: 0.5rem;
    }
    
    .button-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 2rem 0;
    }
    
    #listenButton {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: #3f51b5;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s, transform 0.3s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    #listenButton:hover {
      background-color: #303f9f;
      transform: scale(1.05);
    }
    
    #listenButton svg {
      width: 50px;
      height: 50px;
      fill: #fff;
    }
    
    #buttonCaption,
    #listeningText {
      margin-top: 1rem;
      color: #555;
    }
    
    #listeningText {
      font-weight: bold;
      display: none;
    }
    
    .loader {
      display: none;
      --uib-size: 80px;
      --uib-color: #3f51b5;
      --uib-speed: 2.5s;
      height: var(--uib-size);
      width: var(--uib-size);
      margin-top: 1rem;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
    }
    
    .slice {
      position: relative;
      height: calc(var(--uib-size) / 6);
      width: 100%;
    }
    
    .slice::before,
    .slice::after {
      --uib-a: calc(var(--uib-speed) / -2);
      --uib-b: calc(var(--uib-speed) / -6);
      content: '';
      position: absolute;
      top: 0;
      left: calc(50% - var(--uib-size) / 12);
      height: 100%;
      width: calc(100% / 6);
      border-radius: 50%;
      background-color: var(--uib-color);
      animation: orbit var(--uib-speed) linear infinite;
      transition: background-color 0.3s ease;
    }
    
    .slice:nth-child(1)::after { animation-delay: var(--uib-a); }
    .slice:nth-child(2)::before { animation-delay: var(--uib-b); }
    .slice:nth-child(2)::after { animation-delay: calc(var(--uib-a) + var(--uib-b)); }
    .slice:nth-child(3)::before { animation-delay: calc(var(--uib-b) * 2); }
    .slice:nth-child(3)::after { animation-delay: calc(var(--uib-a) + var(--uib-b) * 2); }
    .slice:nth-child(4)::before { animation-delay: calc(var(--uib-b) * 3); }
    .slice:nth-child(4)::after { animation-delay: calc(var(--uib-a) + var(--uib-b) * 3); }
    .slice:nth-child(5)::before { animation-delay: calc(var(--uib-b) * 4); }
    .slice:nth-child(5)::after { animation-delay: calc(var(--uib-a) + var(--uib-b) * 4); }
    .slice:nth-child(6)::before { animation-delay: calc(var(--uib-b) * 5); }
    .slice:nth-child(6)::after { animation-delay: calc(var(--uib-a) + var(--uib-b) * 5); }
    
    @keyframes orbit {
      0%   { transform: translateX(calc(var(--uib-size) * 0.25)) scale(0.73684); opacity: 0.65; }
      5%   { transform: translateX(calc(var(--uib-size) * 0.235)) scale(0.684208); opacity: 0.58; }
      10%  { transform: translateX(calc(var(--uib-size) * 0.182)) scale(0.631576); opacity: 0.51; }
      15%  { transform: translateX(calc(var(--uib-size) * 0.129)) scale(0.578944); opacity: 0.44; }
      20%  { transform: translateX(calc(var(--uib-size) * 0.076)) scale(0.526312); opacity: 0.37; }
      25%  { transform: translateX(0%) scale(0.47368); opacity: 0.3; }
      30%  { transform: translateX(calc(var(--uib-size) * -0.076)) scale(0.526312); opacity: 0.37; }
      35%  { transform: translateX(calc(var(--uib-size) * -0.129)) scale(0.578944); opacity: 0.44; }
      40%  { transform: translateX(calc(var(--uib-size) * -0.182)) scale(0.631576); opacity: 0.51; }
      45%  { transform: translateX(calc(var(--uib-size) * -0.235)) scale(0.684208); opacity: 0.58; }
      50%  { transform: translateX(calc(var(--uib-size) * -0.25)) scale(0.73684); opacity: 0.65; }
      55%  { transform: translateX(calc(var(--uib-size) * -0.235)) scale(0.789472); opacity: 0.72; }
      60%  { transform: translateX(calc(var(--uib-size) * -0.182)) scale(0.842104); opacity: 0.79; }
      65%  { transform: translateX(calc(var(--uib-size) * -0.129)) scale(0.894736); opacity: 0.86; }
      70%  { transform: translateX(calc(var(--uib-size) * -0.076)) scale(0.947368); opacity: 0.93; }
      75%  { transform: translateX(0%) scale(1); opacity: 1; }
      80%  { transform: translateX(calc(var(--uib-size) * 0.076)) scale(0.947368); opacity: 0.93; }
      85%  { transform: translateX(calc(var(--uib-size) * 0.129)) scale(0.894736); opacity: 0.86; }
      90%  { transform: translateX(calc(var(--uib-size) * 0.182)) scale(0.842104); opacity: 0.79; }
      95%  { transform: translateX(calc(var(--uib-size) * 0.235)) scale(0.789472); opacity: 0.72; }
      100% { transform: translateX(calc(var(--uib-size) * 0.25)) scale(0.73684); opacity: 0.65; }
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      animation: fadeInModal 0.5s;
    }
    
    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      text-align: center;
      position: relative;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    
    .modal-close {
      position: absolute;
      right: 15px;
      top: 15px;
      cursor: pointer;
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      transition: color 0.3s;
    }
    
    .modal-close:hover {
      color: #333;
    }
    
    /* Optional Lyrics Container (if you choose to animate lyrics) */
    .lyrics-container {
      margin-top: 1.5rem;
      min-height: 3em;
      font-size: 1.2rem;
      color: #444;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .lyrics-line {
      opacity: 0;
      animation: fadeIn 0.5s forwards;
      margin: 0;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Debug Console (for troubleshooting) */
    #debugConsole {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 300px;
      height: 200px;
      background-color: rgba(0, 0, 0, 0.85);
      color: #fff;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      overflow-y: auto;
      border-radius: 5px;
    }
    
    @media (max-width: 768px) {
      h1 { font-size: 1.5rem; }
      #listenButton { width: 80px; height: 80px; }
      #listenButton svg { width: 40px; height: 40px; }
      .loader { --uib-size: 60px; }
      #debugConsole { width: 200px; height: 150px; font-size: 10px; }
    }
  </style>
</head>
<body>
  <h1>Lyrical Master</h1>
  <p class="note">This site is still under development and accuracy varies.</p>
  
  <div class="button-container">
    <button id="listenButton">
      <!-- Microphone SVG Icon -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
      </svg>
    </button>
    <p id="buttonCaption">Press to Listen</p>
    <p id="listeningText">Listening</p>
    <div class="loader">
      <div class="container">
        <div class="slice"></div>
        <div class="slice"></div>
        <div class="slice"></div>
        <div class="slice"></div>
        <div class="slice"></div>
        <div class="slice"></div>
      </div>
    </div>
  </div>
  
  <!-- Modal for displaying the recognized song info and embedded YouTube video -->
  <div id="resultModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <div id="modalSongInfo"></div>
    </div>
  </div>
  
  <!-- Debug console (optional) -->
  <div id="debugConsole"></div>
  
  <script>
    // API details
    const AUDD_API_KEY = "95ed2b366d6b459f91aa98afb222499d";
    const AUDD_API_URL = "https://api.audd.io/";
    const YOUTUBE_API_KEY = "AIzaSyCg4_QVRRhcKpAt0v5xhQXTRemwqEbJC3o";
    
    // Get DOM elements
    const listenButton = document.getElementById('listenButton');
    const buttonCaption = document.getElementById('buttonCaption');
    const listeningText = document.getElementById('listeningText');
    const loader = document.querySelector('.loader');
    const debugConsole = document.getElementById('debugConsole');
    const resultModal = document.getElementById('resultModal');
    const modalSongInfo = document.getElementById('modalSongInfo');
    const modalClose = document.querySelector('.modal-close');
    
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    
    function log(message) {
      const logEntry = document.createElement('div');
      logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      debugConsole.appendChild(logEntry);
      debugConsole.scrollTop = debugConsole.scrollHeight;
    }
    
    // Start recording audio for 5 seconds
    function startRecording() {
      isRecording = true;
      buttonCaption.style.display = 'none';
      listeningText.style.display = 'block';
      loader.style.display = 'block';
      log("Requesting microphone access...");
      
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          log("Microphone access granted. Starting recording...");
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          
          mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };
          
          mediaRecorder.onstop = () => {
            log("Recording stopped. Processing audio...");
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            sendAudio(audioBlob);
            // Release the microphone
            stream.getTracks().forEach(track => track.stop());
          };
          
          mediaRecorder.start();
          // Stop recording after 5 seconds
          setTimeout(() => {
            if (mediaRecorder.state !== "inactive") {
              mediaRecorder.stop();
            }
            isRecording = false;
            buttonCaption.style.display = 'block';
            listeningText.style.display = 'none';
          }, 5000);
        })
        .catch(err => {
          log("Error accessing microphone: " + err);
          listeningText.style.display = 'none';
          loader.style.display = 'none';
        });
    }
    
    // Send the recorded audio to the AudD API for song recognition
    function sendAudio(audioBlob) {
      log("Sending audio to AudD API...");
      const formData = new FormData();
      formData.append("api_token", AUDD_API_KEY);
      formData.append("file", audioBlob, "recording.wav");
      
      fetch(AUDD_API_URL, {
        method: "POST",
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        log("AudD API response: " + JSON.stringify(data));
        if (data && data.result) {
          const title = data.result.title || "Unknown Title";
          const artist = data.result.artist || "Unknown Artist";
          // Now search YouTube for a lyric video using the recognized song info
          showModal(title, artist);
        } else {
          showModal("Song not recognized", "Please try again.", "");
        }
        loader.style.display = 'none';
      })
      .catch(error => {
        log("Error from AudD API: " + error);
        showModal("Error", "There was an error recognizing the song.", "");
        loader.style.display = 'none';
      });
    }
    
    // Search YouTube for a lyric video based on song title and artist
    function searchYouTubeForVideo(song) {
      const query = encodeURIComponent(`${song.title} ${song.artist} lyrics`);
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${query}&type=video&maxResults=1&key=${YOUTUBE_API_KEY}`;
      return fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.items && data.items.length > 0) {
            const videoId = data.items[0].id.videoId;
            log("Found YouTube video ID: " + videoId);
            return videoId;
          } else {
            throw new Error("No video found");
          }
        });
    }
    
    // Display the modal with song info and embed the YouTube video
    function showModal(title, artist, lyrics) {
      let html = `<h2>${title}</h2><h3>${artist}</h3>`;
      html += `<div id="youtubeContainer"></div>`;
      if (lyrics) {
        html += `<div class="lyrics-container"></div>`;
      }
      modalSongInfo.innerHTML = html;
      resultModal.style.display = "block";
      
      // Search YouTube and embed the video
      searchYouTubeForVideo({ title, artist })
        .then(videoId => {
          var ytContainer = document.getElementById("youtubeContainer");
          ytContainer.innerHTML = `<div id="ytplayer"></div>`;
          new YT.Player("ytplayer", {
            height: '360',
            width: '640',
            videoId: videoId,
            events: {
              'onReady': event => { event.target.playVideo(); },
              'onStateChange': event => { /* Optionally handle state changes */ }
            }
          });
        })
        .catch(error => {
          log("Error embedding YouTube video: " + error);
        });
      
      if (lyrics) {
        animateLyrics(lyrics);
      }
    }
    
    // Animate lyrics line by line (if provided; currently unused)
    function animateLyrics(lyrics) {
      const lines = lyrics.split(/\r?\n/).filter(line => line.trim() !== "");
      const container = document.querySelector(".lyrics-container");
      container.innerHTML = "";
      let index = 0;
      
      function displayLine() {
        if (index < lines.length) {
          container.innerHTML = `<p class="lyrics-line">${lines[index]}</p>`;
          index++;
          setTimeout(displayLine, 3000);
        } else {
          container.innerHTML = "";
        }
      }
      
      displayLine();
    }
    
    // Close the modal when the close button is clicked
    modalClose.addEventListener('click', () => {
      resultModal.style.display = "none";
    });
    
    // Also close the modal if the user clicks outside the modal content
    window.addEventListener('click', event => {
      if (event.target === resultModal) {
        resultModal.style.display = "none";
      }
    });
    
    // Start recording when the button is pressed
    listenButton.addEventListener('click', () => {
      if (!isRecording) {
        startRecording();
      }
    });
    
    log("Lyrical Master initialized");
    
    // Load the YouTube IFrame Player API asynchronously
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
  </script>
</body>
</html>
